# 16장 스파크 튜닝

16장에서 다루는 내용

* 스파크 잡 모니터링
* 스파크 설정
* 스파크 앱 개발 시 일반적인 실수 
* 최적화 기술

## 스파크 잡 모니터링
* 스파크 웹 UI를 사용해 잡을 모니터링 하는 방법을 설명
* 튜닝을 잘하기 위해 스파크의 로깅 정차에 대해 알아본다.

### 스파크 웹 인터페이스
* 잡 실행이 완료된 후 웹 UI를 보고 싶다면 

> 스파크 잡을 제출하기 전에 spark.eventLog.enabled=true 로 설정한다.

#### 잡(Job)
DAG 스케줄러의 두 가지 기본 개념

* 잡
* 스테이지

#### 스테이지


#### 저장소
* RDD, 데이터 프레임, 데이터셋의 크기와 메모리 사용량이 표시된다.
* 주 메모리에 RDD를 캐싱할 수 없으면 대신 디스크 공간이 사용된다.

#### 환경


#### 익스큐터(p.820)
* 익스큐터는 태스크 실행을 담당하는 분산 에이전트다.
* 익스큐터가 시작되면 익스큐터는 먼저 드라이버와 함께 등록하고 다음 그림(p.822)처럼 태스크를 실행하기 위해 태스크와 직접 통신한다.

#### SQL
스파크 UI의 SQL 탭에는 연산자마다 모든 누산기 값을 표시한다.
http://localhost:4040/SQL/
기본적으로 모든 SQL 쿼리 실행과 기본 정보를 표시한다.


### 웹 UI를 사용한 스파크 애플리케이션 시각화

#### 실행 중인 스파크 잡 완료 확인

#### 로그를 이용한 스파크 애플리케이션 디버깅

#### 스파크에서 log4j로 로깅


## 스파크 설정
시스템을 설정할 수 있는 세 부분

* 스파크 프로퍼티
* 환경 변수
* 로깅

### 스파크 프로퍼티
* 필요에 따라 스파크 프로퍼티를 동적으로 로드해야 하는 특별한 경우도 있다.
* spark-submit 스크립트를 통해 스파크 잡을 제출할 때 동적으로 로딩할 수 있다.
  * SparkConf의 특정 설정을 하드 코딩하지 않아도 된다.

> 스파크 우선순위

    config 파일 설정의 우선순위가 가장 낮음
    실제 코드의 설정은 보다 높음
    spark-submit 스크립트를 통해 CLI에서 사용하는 설정은 더 높은 우선순위를 가짐

### 환경 변수 (p.834)

### 로깅


## 스파크 애플리케이션을 개발할 때 저지르는 일반적인 실수

### 애플리케이션 실패

#### 느린 잡 또는 응답 없음
* 드라이버 프로그램의 느린 잡 계산일 수 있다.
* 하드웨어 실패 일 수 있다.
* 자바 GC
* 느린 응답. 잡의 느린 성능은 데이터 직렬화 부족 때문일 수 있다.


## 최적화 기술

### 데이터 직렬화
* 직렬화는 모든 분산 컴퓨팅 환경에서 성능 향상과 최적화에 중요한 튜닝 요소다.
* 스파크의 데이터 직렬화에 대한 두 개의 옵션
  * 자바 직렬화
    * 매우 유연하지만 종종 매우 느리다. 대용량 데이터 객체 직렬화에 적합하지 않다.
  * Kryo 직렬화
    * 자바 직렬화에 비해 10배 빠르고 압축한다.

### 메모리 튜닝

메모리 사용을 튜닝할 때 세가지 고려사항

* 객체가 사용하는 메모리 크기
* 해당 객체에 접근하는 비용
* 가비지 컬렉션의 오버헤드

#### 메모리 사용량과 메모리 관리
* 메모리 사용 분류
  * 실행 메모리
  * 저장소 메모리

#### 데이터 구조 튜닝
1. 객체 배열과 기본 타입을 더 많이 사용하도록 데이터 구조를 설계한다.
1. 가능하면 작은 객체와 포인터가 많은 중첩 구조를 사용하지 않는다.
1. 가능하면 키에 문자열을 사용하는 대신 숫자ID를 사용하거나 enum 객체를 사용하는 것을 고려한다.

#### 직렬화된 RDD 저장소
MEMORY_ONLY_SER ???

#### 가비지 컬렉션 튜닝
* GC는 처리 시간과 저장 관점에서 비용이 많이 드는 연산이다.
  * 데이터 구조를 튜닝하는 것이 강력히 권장된다.
  * 메모리에 저장된 객체 수를 줄이는 것이 좋다.

* GC 튜닝의 첫 번째 단계
  * 장비에서 JVM 가비지 컬렉션이 발생하는 빈도에 대한 관련 통계를 수집
  * JVM이 GC에 소비한 시간에 대한 통계를 얻는다.

#### 병렬화 레벨
컴퓨팅 클러스터 노드의 전체 컴퓨팅 자원이 활용되지 않을 수 있다.
따라서 병렬 처리 레벨을 두번째 파라미터로 설정해야 한다.

#### 브로드캐스팅
* 브로드캐스팅 변수를 사용하면 드라이버에서 종속 태스크와 자체 복사본을 전송하지 않고 각 드라이버에 캐싱된 인스턴스나 클래스 변수의 읽기 전용 복사본을 유지할 수 있다.
* 그러나 여러 스테이지의 태스크가 역직렬화 형식으로 동일 데이터를 필요할때에만 브로드캐스팅 변수를 명시적으로 생성하는 것이 유용하다.

#### 데이터 지역성
* 데이터 지역성은 데이터가 처리할 코드와 얼마나 가까운지를 의미한다.

## 요약
* 스파크 잡을 튜닝할 수 있는 기본 기술을 설명했다.
* 스파크 웹 UI에 접근해 잡을 모니터링하는 방법을 설명했다.
* 스파크 설정 파라미터의 설정 방법을 설명했다
* 스파크 사용자가 실수할 수 있는 내용과 해결 방법을 제안했다.
* 스파크 애플리케이션을 튜닝할 때 도움이 되는 최적화 기술에 대해 설명했다.

