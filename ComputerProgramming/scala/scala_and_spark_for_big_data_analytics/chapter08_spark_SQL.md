# 8장 스파크 SQL

구조화된 데이터로 스파크 분석 방법을 다룬다.
데이터 프레임과 데이터셋이 왜 중요하게 됐는지, 스파크 SQL API에서 구조화된 데이터를 단순하지만 견고하게 쿼리하는 방법을 보여준다.
또한 데이터셋을 소개하고 데이터셋, 데이터 프레임, RDD의 차이점을 확인한다.

8장에서 다루는 내용

* SparkSQL과 데이터 프레임
* 데이터 프레임과 SQL API
* 데이터 프레임 스키마
* 데이터셋과 인코더
* 데이터 로드와 저장
* 집계
* 조인

## 스파크 SQL과 데이터 프레임

* 스파크 SQL은 SQL과 같은 Statement을 AST(Abstract Syntax Tree)로 파싱한 Plan을 논리적 계획으로 변환한 후 해당 논리적 계획을 실행 가능한 물리 계획으로 최적화함으로써 동작한다.
* 마지막에는 스파크의 기본 데이터 프레임 API를 사용해 실행된다.
* 스파크의 모든 내부 정보를 배워서 사용해야 하는 대신 SQL과 유사한 인터페이스를 적용해서 누구나 데이터 프레임 API를 쉽게 사용할 수 있다.

* 데이터 프레임은 RDD(Resilient Distributed Dataset)을 추상화한 것으로, 카탈리스트 최적화기(Catalyst Optimizer)를 사용해 최적화된 고급 기능과 텅스텐 프로젝트를 통한 높은 성능을 제공한다.

* 데이터 프레임은 개념적으로 관계형 데이터베이스의 테이블과 비슷하다.

* 스파크 1.6 이전 릴리스와 비교해 텅스텐 성능 개선 부분은 스파크 2.x에서 제공하는 놀랄 만한 성능이 개선된 또 다른 핵심 요소다.


## 데이터 프레임 API와 SQL API

데이터 프레임을 여러 방법으로 생성할 수 있다.

* SQL 쿼리를 실행
* Parquet, JSON, CSV, 텍스트, Hive, JDBC 등과 같은 외부 데이터를 로그
* RDD를 데이터 프레임으로 변환

데이터 프레임은 CSV 파일을 로드함으로써 생성할 수 있다.


### 피벗
* 여러 가지 요약과 집계를 수행하는 데 더 적합한 다른 뷰를 생성하기 위해 테이블을 변환하는 좋은 방법이다.
* 피벗은 칼럼의 값을 얻어 각각의 값을 실제 칼럼으로 만들며 수행된다.

### 필터
* 필터는 데이터 프레임을 좁힐 수 있는 데이터의 매우 중요한 변환을 가능케 한다.

### 사용자 정의 함수(UDF)
* UDF는 스파크 SQL의 기능을 확장하는 새로운 칼럼 기반 함수를 정의한다.

### 데이터의 스키마 구조
스키마는 데이터 구조에 대한 설명이고 암시적이거나 명시적일 수 있다.

#### 암시 스키마

#### 명시 스키마

#### 인코더


### 데이터셋 로드와 저장

#### 데이터셋 로드
spark.read.inputtype

* Parquet
* CSV
* Hive table
* JDBC
* ORC
* Text
* JSON

#### 데이터셋 저장
dataframe.write.outputtype

* Parquet
* ORC
* TEXT
* Hive table
* JSON
* CSV
* JDBC


## 집계

### 집계 함수

#### count
#### first
#### last
#### approx_count_distinct 
#### min
#### max
#### average
#### sum
#### 첨도(kurtosis)
* 형태의 차이를 계량화하는 방법
* 평균과 분산의 관점에서는 매우 유사하지만 실제로는 다르다.

#### 비대칭도(skewness)
* 평균 근처의 데이터 값에 대한 비대칭을 측정한다.

#### 분산(variance)
* 개별 값에서 평균의 차를 제곱한 후의 평균이다.

#### 표준 편차(standard deviation)
* 분산의 제곱근이다.

#### 공분산
* 두 랜덤 변수의 결합 가변성을 측정한 것이다.

### groupBy

### rollup

### cube

### 윈도우 함수 
윈도우 함수 사용 사례

* 누적 합계
* 동일한 키에 대한 이전 값의 델타
* 가중 이동 평균

윈도우를 지정하는 API는 세 가지 속성

* partitionBy
* orderBy
* rowsBetween: 계산을 수행할 윈도우 프레임이나 슬라이딩 윈도우의 범위를 지정한다.
  * (예시) .rowsBetween(Window.unboundedPreceding, Window.currentRow)
* ntiles
  * 윈도우에서 널리 사용되는 집계이며, 일반적으로 입력 데이터셋을 n개의 부분집합으로 나눈다.
  * 데이터 과학 모델에서 사용되는 10분위수를 계산할 때 많이 사용된다.


## 조인

### 조인의 내부 동작 

### 브로드캐스트 조인

### 조인 타입

### 조인의 성능 결과 (P.449)


## 요약



